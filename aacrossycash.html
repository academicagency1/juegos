<!DOCTYPE html>
<html>
<head>
    <title>Crossy Cash</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; background: #111; 
            font-family: 'Fredoka One'; color: #fff; 
            overflow: hidden; display: flex; flex-direction: column; 
            height: 100vh; user-select: none; -webkit-user-select: none; 
        }
        
        /* UI LAYOUT */
        #top { 
            background: #151515; padding: 10px; 
            display: flex; justify-content: center; gap: 15px; 
            border-bottom: 4px solid #333; z-index: 10; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); 
        }
        .stat { background: #333; padding: 6px 14px; border-radius: 8px; border: 2px solid #555; font-size: 16px; min-width: 80px; text-align: center; }
        .val { color: #ffd700; }
        
        /* GAME WRAPPER */
        #game-wrap { 
            flex: 1; position: relative; background: #222; 
            cursor: pointer; overflow: hidden; margin: 10px 0; 
            border-top: 4px solid #333; border-bottom: 4px solid #333;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.4);
            touch-action: none; 
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* CONTROLS */
        #btm { 
            background: #151515; padding: 15px; display: flex; justify-content: space-around; 
            border-top: 4px solid #333; z-index: 10; gap: 10px;
        }
        .btn { font-family: 'Fredoka One'; border: none; color: #fff; border-radius: 12px; padding: 12px 10px; font-size: 14px; cursor: pointer; box-shadow: 0 4px 0 #000; transition: 0.1s; text-transform: uppercase; flex: 1; max-width: 120px; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-shop { background: #f39c12; }
        .btn-help { background: #9b59b6; }
        .btn-cash { background: #2ecc71; font-size: 20px; padding: 14px 40px; display: none; max-width: 100%; }
        
        /* OVERLAYS */
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; }
        
        /* FANCY TITLE */
        #title-content {
            background: radial-gradient(circle, rgba(30,60,114,0.85) 0%, rgba(0,0,0,0.95) 100%);
            width: 100%; height: 100%; position: absolute;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto;
            backdrop-filter: blur(3px);
        }
        .title-txt { font-size: 55px; color: #2ecc71; text-shadow: 5px 5px 0 #000; text-align: center; line-height: 1; margin-bottom: 20px; animation: bounce 2s infinite; }
        .start-btn { background: #e74c3c; font-size: 24px; padding: 15px 50px; border-radius: 30px; border: 3px solid #fff; cursor: pointer; box-shadow: 0 6px 0 #c0392b; transition: 0.1s; margin-top: 20px; }
        .start-btn:active { transform: translateY(6px); box-shadow: none; }

        /* DEATH / CASHOUT SCREENS */
        #end-screen { display: none; z-index: 30; pointer-events: auto; background: rgba(0,0,0,0.85); }
        .end-box { background: #fff; color: #333; padding: 30px 40px; border-radius: 15px; border: 5px solid #333; text-align: center; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .end-title { font-size: 40px; margin: 0; text-transform: uppercase; }
        .end-sub { font-size: 20px; color: #777; margin-top: 0px; }

        /* POPUP UI (SHOP & HELP) */
        .popup-ui { display: none; width: 90%; max-width: 380px; max-height: 80%; background: #fff; color: #333; border-radius: 15px; padding: 20px; text-align: center; border: 4px solid #333; overflow-y: auto; pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .item { background: #eee; margin: 8px 0; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .buy-btn { padding: 6px 12px; border-radius: 6px; border: none; color: white; cursor: pointer; font-family: 'Fredoka One'; }

        /* HELP SPECIFIC */
        .help-row { text-align: left; margin-bottom: 12px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .help-icon { font-size: 24px; display: inline-block; width: 30px; }
        .help-desc { font-size: 14px; color: #555; }

        /* FLOATING TEXT ANIMATIONS */
        .float { 
            position: absolute; color: #ffd700; font-size: 28px; pointer-events: none; 
            text-shadow: 2px 2px 0 #000; animation: floatUp 1s forwards; 
            font-weight: 900; left: 50%; transform: translateX(-50%); 
            text-align: center; z-index: 25; white-space: nowrap; will-change: transform, opacity;
        }
        .power-txt { 
            color: #fff; font-size: 45px; text-shadow: 3px 3px 0 #000, 0 0 15px #e74c3c; 
            z-index: 26; animation: powerPop 1.2s forwards; -webkit-text-stroke: 1.5px black;
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes floatUp { 
            0% { opacity: 1; transform: translate(-50%, 0) scale(1); }
            90% { opacity: 1; transform: translate(-50%, -90px) scale(1.1); }
            100% { opacity: 0; transform: translate(-50%, -100px) scale(1.2); } 
        }
        @keyframes powerPop { 
            0% { opacity: 0; transform: translate(-50%, 20px) scale(0); } 
            20% { opacity: 1; transform: translate(-50%, 0) scale(1.3); } 
            40% { opacity: 1; transform: translate(-50%, 0) scale(1); } 
            90% { opacity: 1; transform: translate(-50%, -10px); } 
            100% { opacity: 0; transform: translate(-50%, -50px); }
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="top">
        <div class="stat">PENDING <div class="val" id="ui-pend">0</div></div>
        <div class="stat">BANK <div class="val" id="ui-bank">0</div></div>
    </div>

    <div id="game-wrap">
        <canvas id="cvs"></canvas>
        
        <div id="start-screen" class="overlay" style="pointer-events: none;">
            <div id="title-content">
                <div class="title-txt">CROSSY<br>CASH</div>
                <div style="font-size:50px; margin-bottom:10px;">üêîüí®üí∞</div>
                <div class="start-btn" onclick="startGame(true)">START RUN</div>
            </div>
        </div>

        <div id="end-screen" class="overlay">
            <div class="end-box">
                <h1 class="end-title" id="end-t">CRASHED</h1>
                <div class="end-sub" id="end-s">LOST $0</div>
                <div class="start-btn" style="background:#3498db; font-size:20px; padding:10px 30px; box-shadow: 0 6px 0 #2980b9;" onclick="startGame(false)">TRY AGAIN</div>
                <div class="start-btn" style="background:#f1c40f; color:#000; font-size:18px; padding:10px 30px; margin-top:10px; box-shadow: 0 6px 0 #d4ac0d;" onclick="goHome()">HOME üè†</div>
            </div>
        </div>

        <div id="shop-ui" class="overlay popup-ui">
            <h2>SKIN SHOP</h2>
            <div id="shop-list"></div>
            <button class="btn" style="background:#e74c3c; margin-top:15px; width:100%" onclick="toggleShop(false)">CLOSE</button>
        </div>

        <div id="help-ui" class="overlay popup-ui">
            <h2 style="color:#9b59b6">HOW TO PLAY</h2>
            <div style="text-align:left; font-size:15px; color:#333; margin-bottom:15px;">
                <b>CONTROLS:</b><br>
                ‚¨ÜÔ∏è <b>Tap / Up:</b> Jump Forward<br>
                ‚¨áÔ∏è <b>Swipe Down / Down:</b> Jump Back<br>
                ‚¨ÖÔ∏è <b>Swipe / Left:</b> Move Left<br>
                ‚û°Ô∏è <b>Swipe / Right:</b> Move Right<br><br>
                <b>PROGRESSION:</b><br>
                The game gets faster and harder as your Pending Cash increases. <br>
                Can you make it past $1000?
            </div>
            
            <h3 style="border-top:2px solid #333; padding-top:10px;">POWERUPS (‚ö°)</h3>
            <div class="help-row"><span class="help-icon">üõ°Ô∏è</span> <b>SHIELD:</b> <span class="help-desc">Invincible for 5 seconds.</span></div>
            <div class="help-row"><span class="help-icon">‚ö°</span> <b>SPEED:</b> <span class="help-desc">Hold down screen to move fast!</span></div>
            <div class="help-row"><span class="help-icon">üí∞</span> <b>2X $$$:</b> <span class="help-desc">Double cash value.</span></div>

            <button class="btn" style="background:#e74c3c; margin-top:10px; width:100%" onclick="toggleHelp(false)">CLOSE</button>
        </div>
    </div>

    <div id="btm">
        <button class="btn btn-shop" onclick="toggleShop(true)">üõçÔ∏è SKINS</button>
        <button class="btn btn-help" onclick="toggleHelp(true)">‚ùì HELP</button>
        <button id="btn-cash" class="btn btn-cash" onclick="cashOut(event)">üí∞ CASH OUT</button>
    </div>

    <script>
        const cvs = document.getElementById('cvs');
        const ctx = cvs.getContext('2d');
        const ui = {
            pend: document.getElementById('ui-pend'),
            bank: document.getElementById('ui-bank'),
            start: document.getElementById('start-screen'),
            shop: document.getElementById('shop-ui'),
            help: document.getElementById('help-ui'),
            cash: document.getElementById('btn-cash'),
            end: document.getElementById('end-screen'),
            endT: document.getElementById('end-t'),
            endS: document.getElementById('end-s'),
            wrap: document.getElementById('game-wrap'),
            btm: document.getElementById('btm')
        };

        const LOGIC_W = 400; 
        const CELL = 50; 
        const COLS = 5; 
        const COL_W = LOGIC_W / COLS;
        
        let state = { playing: false, menuOpen: false, banked: 0, pending: 0, combo: 0, skin: 0, owned: [0] };
        
        const skins = [
            {id:0, e:"üêî", n:"Chicken", p:0}, 
            {id:1, e:"üê∑", n:"Piggy", p:50}, 
            {id:9, e:"üê±", n:"Cat", p:100},
            {id:10,e:"üê∂", n:"Dog", p:100},
            {id:2, e:"ü¶ä", n:"Fox", p:125},
            {id:3, e:"ü§ñ", n:"Robot", p:250}, 
            {id:4, e:"üëΩ", n:"Alien", p:500},
            {id:11,e:"üê≤", n:"Dragon", p:1000},
            {id:12,e:"üíÄ", n:"Undead", p:1000},
            {id:5, e:"üëª", n:"Ghost", p:1250},
            {id:6, e:"üßü", n:"Zombie", p:1500}, 
            {id:7, e:"ü¶Ñ", n:"Unicorn", p:2500}, 
            {id:8, e:"üíé", n:"Rich", p:7500},
            {id:13,e:"üí∞", n:"Moneybag", p:100000}
        ];
        const cars = ["üöó","üöï","üöô","üõª","üöê","üöì","üöë", "üèéÔ∏è", "üöú"];
        const powers = ["SHIELD", "SPEED", "2X $$$", "2X COIN", "REVIVE"];

        const load = () => {
            let s = JSON.parse(localStorage.getItem('cc_save_v7') || "{}");
            state.banked = s.banked || 0; state.skin = s.skin || 0; state.owned = s.owned || [0];
            ui.bank.innerText = state.banked;
        };
        const save = () => localStorage.setItem('cc_save_v7', JSON.stringify({banked:state.banked, skin:state.skin, owned:state.owned}));
        load();

        // --- GAME VARIABLES ---
        let player = { col: 2, x: 200, destX: 200, y: 50, destY: 50, hop: 0 }; 
        let camY = 50;
        let objs = []; 
        let coins = [];
        let maxDepth = -200; 
        let shake = 0;
        let isHolding = false;
        let swipeStart = {x:0, y:0};
        
        let activePower = { type: null, timer: 0 }; 

        // --- TIME MANAGEMENT ---
        let lastTime = 0;

        function resize() {
            cvs.width = ui.wrap.clientWidth;
            cvs.height = ui.wrap.clientHeight;
        }
        window.onresize = resize;
        resize();

        function getXForCol(c) {
            return (c * COL_W) + (COL_W/2) - 15;
        }

        function startGame() {
            if(state.menuOpen) return;
            
            state.pending = 0; 
            state.combo = 0;
            ui.pend.innerText = 0;
            
            player = { col: 2, x: getXForCol(2), destX: getXForCol(2), y: 50, destY: 50, hop: 0 };
            camY = 50;
            maxDepth = -200;
            objs = [];
            coins = [];
            activePower = { type: null, timer: 0 };
            isHolding = false;
            
            ui.start.style.display = 'none';
            ui.end.style.display = 'none';
            ui.btm.style.display = 'flex';
            ui.cash.style.display = 'block';
            document.querySelector('.btn-shop').style.display = 'none';
            document.querySelector('.btn-help').style.display = 'none';
            
            state.playing = true;
        }

        function goHome() {
            state.pending = 0;
            ui.pend.innerText = 0;
            ui.end.style.display = 'none';
            ui.start.style.display = 'flex'; 
            ui.btm.style.display = 'flex';
            document.querySelector('.btn-shop').style.display = 'block';
            document.querySelector('.btn-help').style.display = 'block';
            ui.cash.style.display = 'none';
            state.playing = false;
            camY = 50; player.y = 50; objs = [];
        }

        function triggerPower(type) {
            let txt = powers[type];
            floatTxt("‚ö° " + txt + "!", "power-txt");
            if(type === 4) { activePower = { type: 4, timer: 99999 }; } 
            else {
                let dur = (type === 0) ? 300 : 600; 
                activePower = { type: type, timer: dur }; 
            }
        }

        function move(dir) {
            if(!state.playing || state.menuOpen || player.hop > 0) return;
            
            if(dir === 'up') {
                player.destY -= CELL; 
                player.hop = 1; 
                state.combo++;
                updateWorld();
                
                let r = 1 + Math.floor(state.combo * 0.2);
                if(activePower.type === 2 && activePower.timer > 0) r *= 2; 
                state.pending += r;
                ui.pend.innerText = state.pending;
            } else if (dir === 'down') {
                player.destY += CELL; 
                player.hop = 1; 
            } else if (dir === 'left') {
                if(player.col > 0) { player.col--; player.hop = 0.5; }
            } else if (dir === 'right') {
                if(player.col < COLS-1) { player.col++; player.hop = 0.5; }
            }
            player.destX = getXForCol(player.col);
        }

        function updateWorld() {
            let lookAhead = player.destY - 400; 
            if(lookAhead < maxDepth) {
                maxDepth = lookAhead;
                let snapY = Math.round(maxDepth / CELL) * CELL;
                
                let rowNum = Math.abs(Math.round(snapY / CELL));
                if(rowNum % 25 === 0 || Math.random() > 0.4) {
                    let randCol = Math.floor(Math.random() * COLS);
                    coins.push({
                        x: getXForCol(randCol), 
                        y: snapY + 10, 
                        hit: false,
                        super: (rowNum % 25 === 0)
                    });
                }
            }
        }

        function finishGame(type) {
            let finalScore = state.pending;
            state.pending = 0;
            ui.pend.innerText = "0";
            
            state.playing = false; isHolding = false;
            ui.btm.style.display = 'none';
            ui.end.style.display = 'flex';
            ui.cash.style.display = 'none';
            
            if(type === 'die') {
                shake = 20;
                ui.endT.innerText = "CRASHED!"; ui.endT.style.color = "#e74c3c";
                ui.endS.innerText = "LOST $" + finalScore;
            } else {
                ui.endT.innerText = "BANKED!"; ui.endT.style.color = "#2ecc71";
                ui.endS.innerText = "SAVED $" + finalScore;
                state.banked += finalScore;
                save();
            }
            ui.bank.innerText = state.banked;
        }

        function cashOut(e) {
            if(e) e.stopPropagation();
            if(state.pending === 0) return;
            finishGame('cash');
        }

        function die() {
            if(activePower.type === 4) {
                activePower = {type:null, timer:0}; 
                shake = 10; floatTxt("‚ù§Ô∏è REVIVED!", "power-txt");
                objs = objs.filter(o => Math.abs(o.y - player.y) > 100);
                return;
            }
            if((activePower.type === 0 || activePower.type === 1) && activePower.timer > 0) return; 
            finishGame('die');
        }

        function spawnTraffic(dtFactor) {
            let difficulty = Math.min(1, state.pending / 600); 
            // Normalize spawn chance by dtFactor so high FPS doesn't mean more cars
            let spawnChance = (0.03 + (0.08 * difficulty)) * dtFactor; 
            let centerRow = Math.floor(camY / CELL);
            
            for(let i = -8; i < 8; i++) {
                let rowY = (centerRow + i) * CELL + 10;
                let rIndex = Math.abs(centerRow + i);
                if(rIndex % 20 === 0) continue;

                let hasCar = objs.some(o => Math.abs(o.y - rowY) < 10);
                
                if(!hasCar && Math.random() < spawnChance) {
                    let dir = Math.random() > 0.5 ? 1 : -1;
                    let baseSpeed = 5 + (10 * difficulty);
                    let spd = (baseSpeed + Math.random() * 3) * dir;
                    let typeIdx = Math.floor(Math.random()*cars.length);
                    objs.push({ x: dir===1 ? -100 : LOGIC_W+100, y: rowY, s: spd, d: dir, e: cars[typeIdx], w: 30 });
                }
            }
        }

        // --- MAIN LOOP WITH DELTA TIME ---
        function loop(timestamp) {
            requestAnimationFrame(loop);
            
            if (!lastTime) lastTime = timestamp;
            const dt = timestamp - lastTime;
            lastTime = timestamp;

            // Target 60 FPS (approx 16.6ms per frame). 
            // If dt is 16.6, dtFactor is 1. If dt is 33 (lag), dtFactor is 2.
            let dtFactor = dt / (1000 / 60);
            
            // Cap dtFactor to prevent jumping through walls on massive lag spikes
            if(dtFactor > 4) dtFactor = 4; 

            if(!state.playing) {
                camY -= 2 * dtFactor;
                // Chance reduced to account for dtFactor accumulation
                if(Math.random() < 0.05 * dtFactor) spawnTraffic(1); 
            }
            else {
                if(activePower.timer > 0 && activePower.type !== 4) {
                    activePower.timer -= dtFactor;
                    if(activePower.timer <= 0) activePower.type = null;
                }

                if(activePower.type === 1 && isHolding && player.hop <= 0) move('up');

                if(player.hop > 0) {
                    let speed = (activePower.type === 1) ? 0.3 : 0.15;
                    player.hop -= speed * dtFactor; 
                    if(player.hop < 0) player.hop = 0;
                }
                
                // Lerp with DT adjustment
                let lerpSpd = 0.2 * dtFactor;
                player.y += (player.destY - player.y) * lerpSpd;
                player.x += (player.destX - player.x) * lerpSpd;
                
                let targetCam = player.y + 20; 
                let camLerp = 0.1 * dtFactor;
                camY += (targetCam - camY) * camLerp;

                spawnTraffic(dtFactor); 
                
                objs.forEach(o => {
                    if(player.x < o.x + o.w && player.x + 30 > o.x && 
                       player.y < o.y + 25 && player.y + 25 > o.y + 5) {
                        die();
                    }
                });

                coins.forEach(c => {
                    if(!c.hit && Math.abs(player.x - c.x) < 30 && Math.abs(player.y - c.y) < 30) {
                        c.hit = true;
                        if(c.super) {
                            triggerPower(Math.floor(Math.random() * 5));
                        } else {
                            let val = 10;
                            if(activePower.type === 3 && activePower.timer > 0) val = 20; 
                            state.pending += val;
                            ui.pend.innerText = state.pending;
                            floatTxt("+$"+val);
                        }
                    }
                });
            }

            objs = objs.filter(o => Math.abs(o.y - camY) < 900 && o.x > -200 && o.x < LOGIC_W + 200);
            
            // Move cars based on dtFactor
            objs.forEach(o => o.x += o.s * dtFactor);

            if(shake > 0) shake *= Math.pow(0.9, dtFactor);
            draw();
        }

        function draw() {
            let viewH = 200; 
            let scale = cvs.height / viewH;
            let scaleW = LOGIC_W * scale;
            let offX = (cvs.width - scaleW) / 2;
            
            ctx.fillStyle = "#65e36b";
            ctx.fillRect(0, 0, cvs.width, cvs.height);

            ctx.save();
            let shakeY = (Math.random()-0.5)*shake;
            let renderY = (-camY * scale) + (cvs.height/1.35) + shakeY;
            
            ctx.translate(offX + ((Math.random()-0.5)*shake), renderY);
            ctx.scale(scale, scale);

            let startRow = Math.floor(camY / CELL) - 6; 
            
            for(let i=0; i<20; i++) {
                let y = (startRow + i) * CELL;
                let rIndex = Math.abs(Math.round(y / CELL));

                if(rIndex % 20 === 0) {
                    // SAFE GRASS LANE
                    ctx.fillStyle = "#2ecc71";
                    ctx.fillRect(-5000, y+10, 10000, 40);
                    ctx.fillStyle = "#27ae60"; 
                    ctx.fillRect(-5000, y+45, 10000, 5);
                    
                    // SAFE ZONE TEXT
                    ctx.save();
                    ctx.translate(0, y+30);
                    ctx.fillStyle = "rgba(255,255,255,0.3)";
                    ctx.font = "900 20px Fredoka One, Arial";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText("SAFE ZONE", 200, 0); 
                    ctx.restore();
                } else {
                    // DANGEROUS ROAD
                    ctx.fillStyle = "#505050";
                    ctx.fillRect(-5000, y+10, 10000, 40);
                    
                    ctx.strokeStyle = "#fff"; ctx.lineWidth = 2; ctx.setLineDash([10,15]);
                    ctx.beginPath(); ctx.moveTo(-5000, y+30); ctx.lineTo(5000, y+30); ctx.stroke();
                }
            }

            const drawE = (e, x, y, s=1) => {
                ctx.save(); 
                ctx.translate(x+20, y+20); 
                ctx.scale(s, s); 
                
                ctx.fillStyle = "rgba(0,0,0,0.3)"; 
                ctx.beginPath(); 
                ctx.ellipse(0, 15, 16, 5, 0, 0, Math.PI*2); 
                ctx.fill();
                
                ctx.globalAlpha = 1.0; 
                ctx.font = "40px Arial"; 
                ctx.textAlign = "center"; 
                ctx.textBaseline = "middle";
                ctx.fillStyle = "#fff"; 
                ctx.fillText(e, 0, 0);
                
                ctx.restore();
            };

            let spin = Math.abs(Math.sin(Date.now()/200));
            coins = coins.filter(c => Math.abs(c.y - camY) < 800 && !c.hit);
            coins.forEach(c => {
                ctx.save(); ctx.translate(c.x+15, c.y+15); ctx.scale(spin, 1);
                ctx.beginPath(); ctx.arc(0,0,12,0,Math.PI*2); 
                if(c.super) { ctx.fillStyle="#8e44ad"; ctx.strokeStyle="#fff"; } 
                else { ctx.fillStyle="#FFD700"; ctx.strokeStyle="#B8860B"; }
                ctx.fill(); ctx.lineWidth=2; ctx.stroke();
                ctx.fillStyle = c.super ? "#fff" : "#B8860B"; 
                ctx.font="bold 16px Arial"; ctx.textAlign="center"; ctx.textBaseline="middle"; 
                ctx.fillText(c.super ? "‚ö°" : "$",0,1);
                ctx.restore();
            });

            objs.forEach(o => {
                ctx.save(); 
                if(o.d === 1) { ctx.translate(o.x+40, o.y); ctx.scale(-1, 1); ctx.translate(-o.x, -o.y); }
                drawE(o.e, o.x, o.y);
                ctx.restore();
            });

            if(state.playing) {
                let bounce = 1 - (Math.sin(player.hop * Math.PI) * 0.3);
                let jumpY = Math.sin(player.hop * Math.PI) * -20;
                let skin = skins.find(s=>s.id === state.skin).e;

                if((activePower.type === 0 || activePower.type === 1) && activePower.timer > 0) {
                     ctx.save();
                     ctx.translate(player.x+20, player.y+20 + jumpY);
                     ctx.beginPath(); ctx.arc(0,0,25,0,Math.PI*2);
                     ctx.fillStyle = `rgba(0, 255, 255, ${0.3 + Math.sin(Date.now()/50)*0.2})`;
                     ctx.fill();
                     ctx.restore();
                }
                drawE(skin, player.x, player.y + jumpY, bounce);
            }

            ctx.restore();
        }

        // --- MENU LOGIC ---
        function toggleShop(open) {
            state.menuOpen = open;
            ui.shop.style.display = open ? 'block' : 'none';
            handleMenuVis(open);
            if(open) {
                let lst = document.getElementById('shop-list');
                lst.innerHTML = "";
                skins.forEach(s => {
                    let owned = state.owned.includes(s.id);
                    let active = state.skin === s.id;
                    let btn = active ? `<span style="color:#27ae60">EQUIPPED</span>` : (owned ? `<button class="buy-btn" style="background:#3498db" onclick="setSkin(${s.id})">WEAR</button>` : `<button class="buy-btn" style="background:${state.banked>=s.p?'#f39c12':'#bdc3c7'}" ${state.banked>=s.p?'':'disabled'} onclick="buySkin(${s.id})">$${s.p}</button>`);
                    lst.innerHTML += `<div class="item"><span style="font-size:24px">${s.e} ${s.n}</span>${btn}</div>`;
                });
            }
        }

        function toggleHelp(open) {
            state.menuOpen = open;
            ui.help.style.display = open ? 'block' : 'none';
            handleMenuVis(open);
        }

        function handleMenuVis(isOpen) {
            if(isOpen) {
                ui.start.style.display = 'none';
            } else {
                if(!state.playing && !ui.end.style.display.includes('flex')) ui.start.style.display = 'flex';
            }
        }

        window.buySkin = (id) => {
            let s = skins.find(x=>x.id===id);
            if(state.banked >= s.p) { state.banked -= s.p; state.owned.push(id); save(); toggleShop(true); ui.bank.innerText=state.banked; }
        };
        window.setSkin = (id) => { state.skin = id; save(); toggleShop(true); };

        function floatTxt(t, c) {
            let el = document.createElement('div'); el.className='float ' + (c||''); el.innerText=t;
            let rX = (Math.random() - 0.5) * 60; 
            let rY = (Math.random() - 0.5) * 60; 
            el.style.left = `calc(50% + ${rX}px)`;
            el.style.top = `calc(40% + ${rY}px)`;
            ui.wrap.appendChild(el); 
            setTimeout(()=>el.remove(), 1000);
        }

        // --- INPUT HANDLING ---
        const handleStart = (e) => {
            if(e.cancelable) e.preventDefault();
            if(e.touches) {
                swipeStart = {x: e.touches[0].clientX, y: e.touches[0].clientY};
            } else {
                swipeStart = {x: e.clientX, y: e.clientY};
            }
            isHolding = true;
        };

        const handleEnd = (e) => {
            if(e.cancelable) e.preventDefault();
            isHolding = false;
            
            let endX = 0, endY = 0;
            if(e.changedTouches) {
                endX = e.changedTouches[0].clientX;
                endY = e.changedTouches[0].clientY;
            } else {
                endX = e.clientX;
                endY = e.clientY;
            }

            let dx = endX - swipeStart.x;
            let dy = endY - swipeStart.y;
            
            if(Math.abs(dx) > 30 && Math.abs(dx) > Math.abs(dy)) {
                if(dx > 0) move('right');
                else move('left');
            } else {
                if(dy > 30) move('down');
                else if(dy < -30) move('up');
                else move('up');
            }
        };

        cvs.addEventListener('mousedown', handleStart);
        cvs.addEventListener('mouseup', handleEnd);
        cvs.addEventListener('touchstart', handleStart, {passive: false});
        cvs.addEventListener('touchend', handleEnd);

        window.onkeydown = (e) => {
            if(e.repeat) return;
            if(e.key === "w" || e.key === "ArrowUp" || e.code === "Space") move('up');
            if(e.key === "s" || e.key === "ArrowDown") move('down');
            if(e.key === "a" || e.key === "ArrowLeft") move('left');
            if(e.key === "d" || e.key === "ArrowRight") move('right');
            if(e.key === "Enter") cashOut();
        };

        // Start Loop
        requestAnimationFrame(loop);
    </script>
</body>
</html>
